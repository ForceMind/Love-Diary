<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°ç³»ç»Ÿæµ‹è¯• - å¿ƒåŠ¨æ—¥è®°</title>
    <link rel="stylesheet" href="assets/css/styles.css">
    <style>
        .test-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        .test-section {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            border-left: 4px solid #007bff;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .test-result {
            background: #fff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .major-selector {
            margin: 10px 0;
        }
        .major-selector select {
            padding: 8px;
            font-size: 16px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .day-scheduler {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        .day-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #ddd;
            text-align: center;
            cursor: pointer;
        }
        .day-item:hover {
            border-color: #007bff;
        }
        .day-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .day-type {
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸŒ¸ å¿ƒåŠ¨æ—¥è®° - æ–°ç³»ç»Ÿæµ‹è¯•</h1>
        
        <div class="test-section">
            <h2>1. ä¸“ä¸šåŒ¹é…ç³»ç»Ÿæµ‹è¯•</h2>
            <div class="major-selector">
                <label>é€‰æ‹©ä¸“ä¸šï¼š</label>
                <select id="majorSelect">
                    <option value="è®¡ç®—æœºç§‘å­¦">è®¡ç®—æœºç§‘å­¦</option>
                    <option value="è½¯ä»¶å·¥ç¨‹">è½¯ä»¶å·¥ç¨‹</option>
                    <option value="æ–‡å­¦">æ–‡å­¦</option>
                    <option value="ä¸­æ–‡">ä¸­æ–‡</option>
                    <option value="å•†å­¦">å•†å­¦</option>
                    <option value="ç»æµå­¦">ç»æµå­¦</option>
                    <option value="è‰ºæœ¯">è‰ºæœ¯</option>
                    <option value="ç¾æœ¯">ç¾æœ¯</option>
                    <option value="åŒ»å­¦">åŒ»å­¦</option>
                    <option value="æŠ¤ç†">æŠ¤ç†</option>
                </select>
                <button class="test-button" onclick="testMajorMatching()">æµ‹è¯•åŒ¹é…</button>
            </div>
            <div id="majorResult" class="test-result"></div>
        </div>

        <div class="test-section">
            <h2>2. æ¯å‘¨æ´»åŠ¨ç³»ç»Ÿæµ‹è¯•</h2>
            <div class="day-scheduler">
                <div class="day-item" onclick="testDayActivity(1)">
                    <div class="day-name">æ˜ŸæœŸä¸€</div>
                    <div class="day-type">å­¦ä¹ æ—¥</div>
                </div>
                <div class="day-item" onclick="testDayActivity(2)">
                    <div class="day-name">æ˜ŸæœŸäºŒ</div>
                    <div class="day-type">ç¤¾äº¤æ—¥</div>
                </div>
                <div class="day-item" onclick="testDayActivity(3)">
                    <div class="day-name">æ˜ŸæœŸä¸‰</div>
                    <div class="day-type">ä¼‘é—²æ—¥</div>
                </div>
                <div class="day-item" onclick="testDayActivity(4)">
                    <div class="day-name">æ˜ŸæœŸå››</div>
                    <div class="day-type">ç¤¾äº¤æ—¥</div>
                </div>
                <div class="day-item" onclick="testDayActivity(5)">
                    <div class="day-name">æ˜ŸæœŸäº”</div>
                    <div class="day-type">å­¦ä¹ æ—¥</div>
                </div>
                <div class="day-item" onclick="testDayActivity(6)">
                    <div class="day-name">æ˜ŸæœŸå…­</div>
                    <div class="day-type">ä¼‘é—²æ—¥</div>
                </div>
                <div class="day-item" onclick="testDayActivity(0)">
                    <div class="day-name">æ˜ŸæœŸæ—¥</div>
                    <div class="day-type">å¶é‡æ—¥</div>
                </div>
            </div>
            <div id="dayResult" class="test-result"></div>
        </div>

        <div class="test-section">
            <h2>3. è§’è‰²å¶é‡ç³»ç»Ÿæµ‹è¯•</h2>
            <button class="test-button" onclick="testEncounterSystem()">æ¨¡æ‹Ÿå¶é‡</button>
            <button class="test-button" onclick="testMultipleEncounters()">æ¨¡æ‹Ÿå¤šæ¬¡å¶é‡</button>
            <div id="encounterResult" class="test-result"></div>
        </div>

        <div class="test-section">
            <h2>4. å®Œæ•´æ¸¸æˆæµç¨‹æµ‹è¯•</h2>
            <button class="test-button" onclick="startTestGame()">å¼€å§‹æµ‹è¯•æ¸¸æˆ</button>
            <button class="test-button" onclick="simulateWeek()">æ¨¡æ‹Ÿä¸€å‘¨</button>
            <div id="gameResult" class="test-result"></div>
        </div>

        <div class="test-section">
            <h2>5. æ•…äº‹çº¿æ•°æ®éªŒè¯</h2>
            <button class="test-button" onclick="validateStoryData()">éªŒè¯æ•…äº‹çº¿æ•°æ®</button>
            <div id="storyResult" class="test-result"></div>
        </div>
    </div>

    <!-- å¼•å…¥æ¸¸æˆè„šæœ¬ -->
    <script src="assets/js/data/GameData.js"></script>
    <script src="assets/js/data/WeeklyActivityData.js"></script>
    <script src="assets/js/core/GameEngine.js"></script>
    <script src="assets/js/core/UIManager.js"></script>
    <script src="assets/js/core/GameLogic.js"></script>

    <script>
        // æµ‹è¯•æ¸¸æˆå®ä¾‹
        let testGameEngine = null;
        let testGameLogic = null;

        // åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ
        function initTestEnvironment() {
            testGameEngine = new GameEngine();
            testGameLogic = new GameLogic(testGameEngine);
        }

        // æµ‹è¯•ä¸“ä¸šåŒ¹é…
        function testMajorMatching() {
            if (!testGameLogic) initTestEnvironment();
            
            const major = document.getElementById('majorSelect').value;
            const matchedCharacter = testGameLogic.getMatchedCharacterByMajor(major);
            const characterInfo = testGameLogic.getCharacterIntroInfo(matchedCharacter);
            
            document.getElementById('majorResult').innerHTML = `
                <h3>åŒ¹é…ç»“æœ</h3>
                <p><strong>ä¸“ä¸šï¼š</strong>${major}</p>
                <p><strong>åŒ¹é…è§’è‰²ï¼š</strong>${characterInfo.name}</p>
                <p><strong>å¶é‡åœ°ç‚¹ï¼š</strong>${characterInfo.location}</p>
                <p><strong>è§’è‰²æè¿°ï¼š</strong>${characterInfo.description}</p>
                <p><strong>ç‰¹é•¿ï¼š</strong>${characterInfo.specialty}</p>
            `;
        }

        // æµ‹è¯•æ¯æ—¥æ´»åŠ¨
        function testDayActivity(dayOfWeek) {
            const dayTheme = WeeklyActivityData.getDayTheme(dayOfWeek);
            const activities = WeeklyActivityData.getDayActivities(dayOfWeek);
            
            let activityHtml = `
                <h3>${dayTheme.emoji} ${dayTheme.name}</h3>
                <p style="color: ${dayTheme.color}"><strong>ä¸»é¢˜ï¼š</strong>${dayTheme.description}</p>
                <h4>å¯ç”¨æ´»åŠ¨ï¼š</h4>
            `;
            
            activities.forEach(activity => {
                let encounterText = '';
                if (activity.encounterChance) {
                    const encounters = Object.entries(activity.encounterChance)
                        .map(([char, chance]) => `${char}(${(chance*100).toFixed(0)}%)`)
                        .join(', ');
                    encounterText = `<br><small>å¶é‡æœºä¼š: ${encounters}</small>`;
                }
                
                let rewardsText = '';
                if (activity.rewards) {
                    const rewards = Object.entries(activity.rewards)
                        .map(([type, amount]) => `${WeeklyActivityData.rewardTypes[type]}+${amount}`)
                        .join(', ');
                    rewardsText = `<br><small>å¥–åŠ±: ${rewards}</small>`;
                }
                
                activityHtml += `
                    <div style="background: #fff; padding: 10px; margin: 5px 0; border-radius: 5px; border-left: 3px solid ${dayTheme.color}">
                        <strong>[${activity.timeRequired}ç‚¹] ${activity.name}</strong>
                        <br>${activity.description}
                        ${rewardsText}
                        ${encounterText}
                    </div>
                `;
            });
            
            document.getElementById('dayResult').innerHTML = activityHtml;
        }

        // æµ‹è¯•å¶é‡ç³»ç»Ÿ
        function testEncounterSystem() {
            const activities = WeeklyActivityData.getDayActivities(0); // æ˜ŸæœŸæ—¥
            const testActivity = activities[0]; // é€‰æ‹©ç¬¬ä¸€ä¸ªæ´»åŠ¨
            
            if (!testActivity.encounterChance) {
                document.getElementById('encounterResult').innerHTML = 'å½“å‰æ´»åŠ¨æ— å¶é‡æœºä¼š';
                return;
            }
            
            let results = '';
            for (let i = 0; i < 10; i++) {
                const random = Math.random();
                let cumulativeChance = 0;
                let encountered = null;
                
                for (const [character, chance] of Object.entries(testActivity.encounterChance)) {
                    cumulativeChance += chance;
                    if (random <= cumulativeChance) {
                        encountered = character;
                        break;
                    }
                }
                
                results += `<p>æµ‹è¯• ${i+1}: ${encountered || 'æ— å¶é‡'} (éšæœºå€¼: ${random.toFixed(3)})</p>`;
            }
            
            document.getElementById('encounterResult').innerHTML = `
                <h3>å¶é‡ç³»ç»Ÿæµ‹è¯•ç»“æœ</h3>
                <p><strong>æµ‹è¯•æ´»åŠ¨ï¼š</strong>${testActivity.name}</p>
                <p><strong>å¶é‡è®¾ç½®ï¼š</strong>${JSON.stringify(testActivity.encounterChance)}</p>
                ${results}
            `;
        }

        // æµ‹è¯•å¤šæ¬¡å¶é‡
        function testMultipleEncounters() {
            const characters = ['LinZhou', 'SongYunshen', 'ZhouYichen', 'TangYan', 'JiangChe'];
            const encounterCounts = {};
            const totalTests = 1000;
            
            characters.forEach(char => encounterCounts[char] = 0);
            
            for (let i = 0; i < totalTests; i++) {
                const random = Math.random();
                const baseChance = 0.2; // æ¯ä¸ªè§’è‰²20%åŸºç¡€æ¦‚ç‡
                
                characters.forEach(char => {
                    if (random < baseChance) {
                        encounterCounts[char]++;
                    }
                });
            }
            
            let resultHtml = `<h3>å¤šæ¬¡å¶é‡ç»Ÿè®¡ (${totalTests}æ¬¡æµ‹è¯•)</h3>`;
            characters.forEach(char => {
                const percentage = (encounterCounts[char] / totalTests * 100).toFixed(1);
                resultHtml += `<p>${char}: ${encounterCounts[char]}æ¬¡ (${percentage}%)</p>`;
            });
            
            document.getElementById('encounterResult').innerHTML = resultHtml;
        }

        // å¼€å§‹æµ‹è¯•æ¸¸æˆ
        function startTestGame() {
            if (!testGameLogic) initTestEnvironment();
            
            const testPlayerData = {
                name: 'æµ‹è¯•ç©å®¶',
                major: 'è®¡ç®—æœºç§‘å­¦',
                personality: 'å¼€æœ—'
            };
            
            // æ¨¡æ‹Ÿæ¸¸æˆå¼€å§‹
            testGameLogic.gameState = testGameLogic.initializeGameState();
            testGameLogic.gameState.player = testPlayerData;
            testGameLogic.gameState.matchedCharacter = testGameLogic.getMatchedCharacterByMajor(testPlayerData.major);
            testGameLogic.gameState.metCharacters = new Set();
            
            const matchedInfo = testGameLogic.getCharacterIntroInfo(testGameLogic.gameState.matchedCharacter);
            
            document.getElementById('gameResult').innerHTML = `
                <h3>æµ‹è¯•æ¸¸æˆå·²å¼€å§‹</h3>
                <p><strong>ç©å®¶ï¼š</strong>${testPlayerData.name}</p>
                <p><strong>ä¸“ä¸šï¼š</strong>${testPlayerData.major}</p>
                <p><strong>æ€§æ ¼ï¼š</strong>${testPlayerData.personality}</p>
                <p><strong>åŒ¹é…è§’è‰²ï¼š</strong>${matchedInfo.name}</p>
                <p><strong>å½“å‰å‘¨æ•°ï¼š</strong>${testGameLogic.gameState.currentWeek}</p>
                <p><strong>è¡ŒåŠ¨ç‚¹ï¼š</strong>${testGameLogic.gameState.actionPoints}/${testGameLogic.gameState.maxActionPoints}</p>
            `;
        }

        // æ¨¡æ‹Ÿä¸€å‘¨
        function simulateWeek() {
            if (!testGameLogic || !testGameLogic.gameState.player) {
                alert('è¯·å…ˆå¼€å§‹æµ‹è¯•æ¸¸æˆ');
                return;
            }
            
            let weekResults = '<h3>ä¸€å‘¨æ¨¡æ‹Ÿç»“æœ</h3>';
            
            for (let day = 1; day <= 7; day++) {
                const dayOfWeek = (day - 1) % 7;
                const dayTheme = WeeklyActivityData.getDayTheme(dayOfWeek);
                const activities = WeeklyActivityData.getDayActivities(dayOfWeek);
                
                if (activities.length > 0 && testGameLogic.gameState.actionPoints > 0) {
                    const randomActivity = activities[Math.floor(Math.random() * activities.length)];
                    
                    if (testGameLogic.gameState.actionPoints >= randomActivity.timeRequired) {
                        testGameLogic.gameState.actionPoints -= randomActivity.timeRequired;
                        
                        // æ£€æŸ¥å¶é‡
                        let encountered = '';
                        if (randomActivity.encounterChance) {
                            const random = Math.random();
                            let cumulativeChance = 0;
                            
                            for (const [character, chance] of Object.entries(randomActivity.encounterChance)) {
                                cumulativeChance += chance;
                                if (random <= cumulativeChance) {
                                    testGameLogic.gameState.metCharacters.add(character);
                                    encountered = ` - é‡åˆ°äº†${testGameLogic.getCharacterIntroInfo(character).name}!`;
                                    break;
                                }
                            }
                        }
                        
                        weekResults += `
                            <p><strong>ç¬¬${day}å¤© (${dayTheme.name}):</strong> 
                            ${randomActivity.name} [æ¶ˆè€—${randomActivity.timeRequired}ç‚¹]${encountered}</p>
                        `;
                    } else {
                        weekResults += `<p><strong>ç¬¬${day}å¤©:</strong> è¡ŒåŠ¨ç‚¹ä¸è¶³ï¼Œä¼‘æ¯</p>`;
                    }
                } else {
                    weekResults += `<p><strong>ç¬¬${day}å¤©:</strong> æ— å¯ç”¨æ´»åŠ¨æˆ–è¡ŒåŠ¨ç‚¹ä¸è¶³</p>`;
                }
            }
            
            // æ¢å¤è¡ŒåŠ¨ç‚¹ (æ¨¡æ‹Ÿä¸‹ä¸€å‘¨)
            testGameLogic.gameState.currentWeek++;
            testGameLogic.gameState.actionPoints = testGameLogic.gameState.maxActionPoints;
            
            weekResults += `
                <hr>
                <p><strong>ç¬¬${testGameLogic.gameState.currentWeek}å‘¨å¼€å§‹</strong></p>
                <p><strong>å·²è®¤è¯†è§’è‰²ï¼š</strong>${Array.from(testGameLogic.gameState.metCharacters).map(char => 
                    testGameLogic.getCharacterIntroInfo(char).name).join(', ') || 'æ— '}</p>
                <p><strong>è¡ŒåŠ¨ç‚¹æ¢å¤åˆ°ï¼š</strong>${testGameLogic.gameState.actionPoints}/${testGameLogic.gameState.maxActionPoints}</p>
            `;
            
            document.getElementById('gameResult').innerHTML = weekResults;
        }

        // éªŒè¯æ•…äº‹çº¿æ•°æ®
        function validateStoryData() {
            let validationResults = '<h3>æ•…äº‹çº¿æ•°æ®éªŒè¯</h3>';
            
            // éªŒè¯WeeklyActivityData
            const weekDays = Object.keys(WeeklyActivityData.weeklySchedule);
            validationResults += `<p>âœ… æ¯å‘¨æ´»åŠ¨æ•°æ®ï¼š${weekDays.length}å¤©çš„æ´»åŠ¨å·²å®šä¹‰</p>`;
            
            let totalActivities = 0;
            weekDays.forEach(day => {
                const activities = WeeklyActivityData.getDayActivities(parseInt(day));
                totalActivities += activities.length;
            });
            validationResults += `<p>âœ… æ€»æ´»åŠ¨æ•°é‡ï¼š${totalActivities}ä¸ª</p>`;
            
            // éªŒè¯è§’è‰²æ•°æ®
            const characters = ['LinZhou', 'SongYunshen', 'ZhouYichen', 'TangYan', 'JiangChe'];
            let charactersWithIntro = 0;
            characters.forEach(char => {
                try {
                    const info = testGameLogic ? testGameLogic.getCharacterIntroInfo(char) : null;
                    if (info) charactersWithIntro++;
                } catch (e) {
                    // è§’è‰²ä¿¡æ¯ä¸å­˜åœ¨
                }
            });
            validationResults += `<p>âœ… è§’è‰²ä»‹ç»æ•°æ®ï¼š${charactersWithIntro}/${characters.length}ä¸ªè§’è‰²æœ‰å®Œæ•´ä¿¡æ¯</p>`;
            
            // éªŒè¯ä¸“ä¸šåŒ¹é…
            const majors = ['è®¡ç®—æœºç§‘å­¦', 'æ–‡å­¦', 'å•†å­¦', 'è‰ºæœ¯', 'åŒ»å­¦'];
            let majorsWithMatching = 0;
            majors.forEach(major => {
                try {
                    const matched = testGameLogic ? testGameLogic.getMatchedCharacterByMajor(major) : null;
                    if (matched) majorsWithMatching++;
                } catch (e) {
                    // ä¸“ä¸šåŒ¹é…ä¸å­˜åœ¨
                }
            });
            validationResults += `<p>âœ… ä¸“ä¸šåŒ¹é…ç³»ç»Ÿï¼š${majorsWithMatching}/${majors.length}ä¸ªä¸“ä¸šæœ‰åŒ¹é…è§’è‰²</p>`;
            
            // éªŒè¯å¥–åŠ±ç³»ç»Ÿ
            const rewardTypes = Object.keys(WeeklyActivityData.rewardTypes);
            validationResults += `<p>âœ… å¥–åŠ±ç³»ç»Ÿï¼š${rewardTypes.length}ç§å¥–åŠ±ç±»å‹å·²å®šä¹‰</p>`;
            
            validationResults += `
                <hr>
                <h4>ç³»ç»ŸçŠ¶æ€</h4>
                <p>âœ… WeeklyActivityData: ${typeof WeeklyActivityData !== 'undefined' ? 'å·²åŠ è½½' : 'æœªåŠ è½½'}</p>
                <p>âœ… GameData: ${typeof GameData !== 'undefined' ? 'å·²åŠ è½½' : 'æœªåŠ è½½'}</p>
                <p>âœ… GameLogic: ${testGameLogic ? 'å·²åˆå§‹åŒ–' : 'æœªåˆå§‹åŒ–'}</p>
            `;
            
            document.getElementById('storyResult').innerHTML = validationResults;
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.onload = function() {
            initTestEnvironment();
            
            // è®¾ç½®æ¯æ—¥æ´»åŠ¨çš„é¢œè‰²
            const dayItems = document.querySelectorAll('.day-item');
            const dayColors = ['#e91e63', '#2196f3', '#ff9800', '#4caf50', '#ff9800', '#2196f3', '#4caf50'];
            
            dayItems.forEach((item, index) => {
                item.style.borderColor = dayColors[index];
                item.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = dayColors[index] + '20';
                });
                item.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = 'white';
                });
            });
        };
    </script>
</body>
</html>
